!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).GCodePreview={})}(this,function(t){"use strict";var e={Cura_SteamEngine:{skirt:"lime","wall-inner":"purple","wall-outer":"blue",skin:"red",fill:"orange",support:"rgba(255,255,255,0.5)"},Simplify3D:{skirt:"lime","inner perimeter":"purple","outer perimeter":"blue",skin:"solid layer",fill:"infill",support:"rgba(255,255,255,0.5)"}};class s{parseLine(t,e){const s={};if(t.startsWith(";"))s.comment=t.slice(1);else{t.split(" ").forEach(t=>{s[t.slice(0,1).toLowerCase()]=+t.slice(1)})}return s}getZone(t,s){if("Cura_SteamEngine"==s.slicer&&t.comment.startsWith("TYPE:"))return t.comment.slice(5).toLowerCase();if("Simplify3D"==s.slicer)for(let s of Object.keys(e.Simplify3D))if(t.comment.includes(s))return s;return null}groupIntoZones(t,e){const s=[{zone:null,commands:[]}];let i=s[0];for(const n of t){if(n.comment){const t=this.getZone(n,e);if(t){i={zone:t,commands:[]},s.push(i);continue}}i.commands.push(n)}return s}groupIntoLayers(t,e){const s=[];let i,n=0;for(const e of t)e.z&&e.z>n&&(0!=n||e.z<1)?(n=e.z,i={layer:s.length,zones:[],commands:[]},s.push(i)):i&&i.commands.push(e);for(let t of s)t.zones=this.groupIntoZones(t.commands,e);return s}parseGcode(t){const e=t.split("\n").filter(t=>t.length>0).map(this.parseLine),s=this.parseHeader(e),i=this.groupIntoLayers(e,s);return{header:s,layers:i,limit:i.length-1}}parseHeader(t){return{slicer:t.filter(t=>t.comment).map(t=>t.comment).filter(t=>/(G|g)enerated/.test(t)).map(t=>t.includes("Slic3r")?"Slic3r":t.includes("Simplify3D")?"Simplify3D":t.includes("Cura_SteamEngine")?"Cura_SteamEngine":void 0)[0]}}}t.Colors=e,t.Preview=class{constructor(t){if(this.parser=new s,this.limit=t.limit,this.scale=t.scale,this.rotation=void 0===t.rotation?0:t.rotation,this.rotationAnimation=t.rotationAnimation,this.zoneColors=t.zoneColors,t.canvas instanceof HTMLCanvasElement)this.canvas=t.canvas,this.ctx=this.canvas.getContext("2d");else{this.targetId=t.targetId;const e=document.getElementById(this.targetId);if(!e)throw new Error("Unable to find element "+this.targetId);this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),e.appendChild(this.canvas),this.resize()}}clear(){this.ctx.clearRect(-this.canvas.width/2,-this.canvas.height/2,this.canvas.width,this.canvas.height)}resize(){this.canvas.width=this.canvas.parentNode.offsetWidth,this.canvas.height=this.canvas.offsetHeight}getZoneColor(t,s){const i=Math.round(s/this.layers.length*80);return this.zoneColors?e[this.header.slicer][t]:"hsl(0, 0%, "+i+"%)"}renderZone(t,e){this.ctx.strokeStyle=this.getZoneColor(t.zone,e),this.ctx.beginPath();for(const e of t.commands)0==e.g?this.ctx.moveTo(e.x,e.y):1==e.g&&(e.e>0?this.ctx.lineTo(e.x,e.y):this.ctx.moveTo(e.x,e.y));this.ctx.stroke()}drawLayer(t,e){if(t>e)return;const s=this.layers[t],i=this.projectIso({x:0,y:0},t);this.ctx.save(),this.ctx.scale(this.scale,this.scale),this.ctx.translate(i.x,i.y),this.ctx.rotate(this.rotation*Math.PI/180),this.ctx.translate(-this.center.x,-this.center.y);for(const e of s.zones)this.renderZone(e,t);this.ctx.restore()}render(){this.canvas.width=this.canvas.width,this.ctx.lineWidth=.1,this.scale||(this.scale=this.autoscale()),this.ctx.scale(1,-1),this.ctx.translate(this.canvas.width/2,-this.canvas.height/2),this.center=this.getAdjustedCenter();for(let t=0;t<this.layers.length;t++)this.drawLayer(t,this.limit)}processGCode(t){console.time("parsing");const{header:e,layers:s,limit:i}=this.parser.parseGcode(t);console.timeEnd("parsing"),this.header=e,this.layers=s,this.limit=i,console.time("rendering"),this.render(),console.timeEnd("rendering")}animationLoop(){this.rotationAnimation&&(requestAnimationFrame(this.animationLoop.bind(this)),this.rotation+=2,this.rotation%=360,this.render())}startAnimation(){this.rotationAnimation=!0,this.animationLoop()}stopAnimation(){this.rotationAnimation=!1}getOuterBounds(t){const e=t||this.layers[0];let s=1/0,i=-1/0,n=1/0,o=-1/0;t:for(let t of e.zones)for(let e of t.commands){if(91==e.g)break t;0!=e.g&&1!=e.g||(e.x<s&&(s=e.x),e.x>i&&(i=e.x),e.y<n&&(n=e.y),e.y>o&&(o=e.y))}return{minX:s,maxX:i,minY:n,maxY:o}}getCenter(t){const e=t||this.layers[0],s=this.getOuterBounds(e);return{x:s.minX+(s.maxX-s.minX)/2,y:s.minY+(s.maxY-s.minY)/2}}getAdjustedCenter(){const t=this.getCenter(this.layers[0]);return this.maxProjectionOffset=this.projectIso({x:0,y:0},this.layers.length-1),console.log(this.maxProjectionOffset),t.x+=this.maxProjectionOffset.x/2,t.y+=this.maxProjectionOffset.y/2,t}getSize(t){const e=t||this.layers[0],s=this.getOuterBounds(e);return{sizeX:s.maxX-s.minX,sizeY:s.maxY-s.minY}}drawBounds(t){const e=t||this.layers[0],{minX:s,maxX:i,minY:n,maxY:o}=this.getOuterBounds(e);this.ctx.moveTo(s,0),this.ctx.lineTo(s,this.canvas.height),this.ctx.stroke(),this.ctx.moveTo(i,0),this.ctx.lineTo(i,this.canvas.height),this.ctx.stroke(),this.ctx.moveTo(0,n),this.ctx.lineTo(this.canvas.width,n),this.ctx.stroke(),this.ctx.moveTo(0,o),this.ctx.lineTo(this.canvas.width,o),this.ctx.stroke()}autoscale(){const{sizeX:t,sizeY:e}=this.getSize(),{width:s,height:i}=this.canvas;var n;return n=t/e>s/i?s/t:i/e,this.scale*=.8,n}projectIso(t,e){return{x:t.x,y:t.y+.1*e}}},Object.defineProperty(t,"__esModule",{value:!0})});
